# Adding a NixOS Recovery Partition on an LVM Logical Volume

This guide explains how to create a bootable recovery partition for your NixOS system using a Logical Volume (LV). This provides a fallback environment for system maintenance or repair, with instructions for both GRUB and `systemd-boot` users.

## 1. Create the Logical Volume

First, create a new logical volume within your existing LVM Volume Group (VG).

1.  **Check available space** in your Volume Group:

    ```bash
    sudo vgs
    ```

2.  **Create the Logical Volume**. Adjust the size (`-L`) and name (`-n`) as needed.

    ```bash
    # Example creates a 10GB volume named 'recovery'
    sudo lvcreate -L 10G -n recovery your-vg-name
    ```

3.  **Format the LV** with a filesystem, such as `ext4`:
    ```bash
    sudo mkfs.ext4 /dev/your-vg-name/recovery
    ```

---

## 2. Prepare the Recovery System

Install a minimal NixOS system onto the new volume. This process is the same for both GRUB and `systemd-boot`.

1.  **Mount the new LV:**

    ```bash
    sudo mount /dev/your-vg-name/recovery /mnt
    ```

2.  **Create a minimal `configuration.nix`** for the recovery system. Save it somewhere like `/tmp/recovery.nix`. The bootloader configuration will be added in the next step.

    ```nix
    # /tmp/recovery.nix
    { config, pkgs, ... }:

    {
      imports = [
        # This will be generated by the install command later
        ./hardware-configuration.nix
      ];

      # Point to the recovery LV as the root
      fileSystems."/" = {
        device = "/dev/your-vg-name/recovery";
        fsType = "ext4";
      };

      # Add essential recovery tools
      environment.systemPackages = with pkgs; [
        gparted
        lvm2
        git
      ];

      # Basic networking
      networking.hostName = "nixos-recovery";
      networking.networkmanager.enable = true;

      # Set a timezone
      time.timeZone = "America/Chicago";

      # Leave users unset to be prompted for a root password on first boot
    }
    ```

3.  **Generate hardware config and install the system.**

    ```bash
    # Generate hardware-configuration.nix inside the recovery root
    sudo nixos-generate-config --root /mnt

    # Install the system using your minimal config
    sudo nixos-install --root /mnt -I nixos-config=/tmp/recovery.nix
    ```

---

## 3. Add the Boot Entry

Now, configure the bootloader to recognize the recovery system.

### For `systemd-boot` Users

The best practice is to have the recovery system install its own boot entry into your shared EFI partition.

1.  **Mount the recovery LV and your EFI partition.** Your EFI partition is likely mounted at `/boot` or `/efi`.

    ```bash
    # Mount the recovery system root
    sudo mount /dev/your-vg-name/recovery /mnt

    # Mount the EFI partition INSIDE the recovery root
    # Replace /dev/sdXN with your actual EFI partition
    sudo mount /dev/sdXN /mnt/boot
    ```

2.  **Edit the recovery system's configuration** at `/mnt/etc/nixos/configuration.nix`. Add the `boot` section below to configure `systemd-boot`.

    ```nix
    # /mnt/etc/nixos/configuration.nix
    { config, pkgs, ... }:
    {
      imports = [ ./hardware-configuration.nix ];

      # ... (all the other settings from Step 2) ...

      # -- ADD THIS SECTION --
      boot.loader.systemd-boot.enable = true;
      boot.loader.efi.canTouchEfiVariables = true;

      # This points to the mount point of your shared EFI partition
      boot.loader.efi.efiSysMountPoint = "/boot";

      # Give a unique name to avoid conflicts with your main system's entries
      boot.loader.systemd-boot.entryName = "NixOS-Recovery";
    }
    ```

3.  **Rebuild the recovery system.** This will create the new bootloader files in your EFI partition.
    ```bash
    # Rebuild the recovery system using its own configuration
    sudo nixos-rebuild switch --target-host nixos@localhost -I nixos-config=/mnt/etc/nixos/configuration.nix
    ```
    Unmount everything (`sudo umount -R /mnt`) and reboot. You should now see "NixOS-Recovery" in your boot menu.

### For GRUB Users

Add a manual entry to your main system's `configuration.nix`.

1.  **Find the UUID and store paths** for the recovery LV.

    - Mount the recovery LV: `sudo mount /dev/your-vg-name/recovery /mnt`
    - Get the UUID: `lsblk -no UUID /dev/your-vg-name/recovery`
    - Get the kernel/initrd paths: `ls -1 /mnt/nix/store | grep 'linux\|initrd'`

2.  **Edit your main system's `/etc/nixos/configuration.nix`** and add the `extraEntries` block.

    ```nix
    # In your PRIMARY system's configuration.nix
    boot.loader.grub.extraEntries = ''
      menuentry "NixOS Recovery" {
        # Replace with the UUID you found
        search --fs-uuid YOUR_RECOVERY_LV_UUID --set=root

        # Replace with the actual kernel and initrd paths you found
        linux /nix/store/xxxxx-linux-6.x.x/bzImage root=/dev/your-vg-name/recovery
        initrd /nix/store/yyyyy-initrd-linux-6.x.x/initrd
      }
    '';
    ```

3.  **Rebuild your main system** to apply the new GRUB entry:
    ```bash
    sudo nixos-rebuild switch
    ```
    Reboot, and the "NixOS Recovery" option will be in your GRUB menu.
